<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Agendar Cita | PsicÃ³logo Kevin Criado</title>
    <meta name="description" content="Agenda tu consulta de telepsicologÃ­a de forma fÃ¡cil y segura. Selecciona el servicio, elige tu horario y prepÃ¡rate para iniciar tu proceso.">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Estilos del Calendario Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* === ESTILOS GENERALES === */
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
            overflow-x: hidden;
        }

        .blobs-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .blob { position: absolute; border-radius: 50%; opacity: 0.6; filter: blur(80px); }
        .blob-1 { width: 400px; height: 400px; background: #EC008C; animation: move-blob-1 25s infinite alternate; }
        .blob-2 { width: 500px; height: 500px; background: #00AEEF; animation: move-blob-2 30s infinite alternate; }
        
        @keyframes move-blob-1 { from { transform: translate(0vw, 0vh) rotate(0deg); } to { transform: translate(50vw, 60vh) rotate(360deg); } }
        @keyframes move-blob-2 { from { transform: translate(80vw, 10vh) rotate(0deg); } to { transform: translate(10vw, 80vh) rotate(-360deg); } }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            width: 100%;
            max-width: 48rem;
            margin: 0 auto;
            padding: 2rem 1.5rem; 
        }
        @media (min-width: 640px) {
            .glass-effect {
                padding: 2.5rem; 
            }
        }

        .title-appear {
            opacity: 0;
            animation: fadeInUp 1s 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .prose-style {
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(233, 213, 255, 0.95);
            max-width: 65ch;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header-container {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .form-group {
            margin-bottom: 2.5rem;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }
        .step-indicator {
            flex-shrink: 0;
            width: 2.25rem;
            height: 2.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(135deg, #EC008C, #00AEEF);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .step-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #fff;
        }
        .step-description {
            font-size: 0.9rem;
            color: rgba(233, 213, 255, 0.8);
        }
        
        .data-fields-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        input[type="text"], input[type="email"], input[type="tel"] {
            width: 100%;
            padding: 0.75rem 1rem; 
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s;
        }
        input.fade-out {
            opacity: 0;
        }

        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus {
            outline: none;
            border-color: #00AEEF;
            box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.3);
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .consulta-selector {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .consulta-option {
            position: relative;
        }
        .consulta-option input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .consulta-label {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.25rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
        }
        .consulta-text-content {
            flex-grow: 1;
        }
        
        .consulta-icon {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            padding: 0.5rem;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: #c4b5fd;
            transition: color 0.3s, background-color 0.3s, transform 0.3s;
        }

        .consulta-option input:checked + .consulta-label {
            background-color: rgba(236, 0, 140, 0.15);
            border-color: rgba(236, 0, 140, 0.5);
        }
        .consulta-option:not(:has(:checked)):hover .consulta-label {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #00AEEF;
        }
        
        .consulta-option input:checked + .consulta-label .consulta-icon {
            background-color: rgba(236, 0, 140, 0.3);
            color: #fda4af;
        }
        
        .consulta-price {
            font-weight: 700;
            color: #5eead4;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .action-button {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 0.875rem 1rem; 
            background-color: rgba(0, 174, 239, 0.3);
            color: white;
            border: 1px solid rgba(0, 174, 239, 0.5);
            border-radius: 9999px;
            font-size: 1rem; 
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, background-color 0.3s ease, opacity 0.3s ease, border-color 0.3s ease;
            animation: pulse-button-glow 4s infinite ease-in-out;
        }

        .action-button:hover:not(:disabled) {
            transform: scale(1.03);
            animation: pulse-button-glow 4s infinite ease-in-out, animate-button-bg 6s infinite ease-in-out;
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: rgba(108, 117, 125, 0.2);
            border-color: rgba(108, 117, 125, 0.3);
            animation: none;
        }
        
        @keyframes pulse-button-glow { 0%, 100% { box-shadow: 0 0 5px rgba(0, 174, 239, 0.3), 0 0 10px rgba(0, 174, 239, 0.3); } 50% { box-shadow: 0 0 15px rgba(0, 174, 239, 0.5), 0 0 25px rgba(0, 174, 239, 0.5); } }
        @keyframes animate-button-bg { 0%, 100% { background-color: rgba(0, 174, 239, 0.3); } 33% { background-color: rgba(236, 0, 140, 0.3); } 66% { background-color: rgba(0, 169, 157, 0.3); } }

        @keyframes bounce-in { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        @keyframes icon-wiggle { 0% { transform: rotate(0deg); } 25% { transform: rotate(-10deg) scale(1.1); } 50% { transform: rotate(10deg) scale(1.1); } 75% { transform: rotate(-5deg) scale(1.1); } 100% { transform: rotate(0deg) scale(1); } }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .animate-icon-wiggle { animation: icon-wiggle 0.6s ease-in-out; }

        #calendar-container {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            justify-content: center;
        }
        #time-slots-wrapper {
            margin-top: 1.5rem;
            max-height: 180px;
            overflow-y: auto;
            padding-right: 0.5rem;
            display: none;
        }
        #time-slots-wrapper.visible {
            display: block;
        }
        #time-slots-wrapper::-webkit-scrollbar { width: 6px; }
        #time-slots-wrapper::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }
        #time-slots-wrapper::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        #time-slots-wrapper::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        #time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 0.75rem;
        }
        .time-group-title {
            grid-column: 1 / -1;
            font-weight: 700;
            color: #5eead4;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .time-slots-placeholder {
            color: #c4b5fd;
            text-align: center;
            padding: 2rem 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-slot-btn {
            padding: 0.6rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 0.5rem;
            color: #fff;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot-btn:hover:not(:disabled) { 
            border-color: #00AEEF;
            box-shadow: 0 0 10px rgba(0, 174, 239, 0.5);
        }
        .time-slot-btn.selected { background-color: #EC008C; border-color: #EC008C; color: #fff; transform: scale(1.05); }
        .time-slot-btn:disabled {
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .flatpickr-calendar { box-shadow: none; width: auto; background: transparent; }
        .flatpickr-months { display: flex; background: transparent; }
        .flatpickr-months .flatpickr-month { flex: 1; background: transparent; color: #ffffff !important; fill: #c4b5fd; }
        .flatpickr-months .flatpickr-prev-month:hover svg, .flatpickr-months .flatpickr-next-month:hover svg { fill: #fff; }
        .flatpickr-current-month .flatpickr-monthDropdown-months, .numInputWrapper .numInput, .flatpickr-current-month .numInput.cur-year { color: #ffffff !important; font-weight: 600; }
        span.flatpickr-weekday { color: #c4b5fd; font-weight: 600; }
        .flatpickr-day {
            color: #ffffff;
            font-weight: 500;
            border: 1px solid transparent;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .flatpickr-day.today:not(.selected) {
            border-color: #00AEEF;
            color: #00AEEF;
        }
        .flatpickr-day:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
        }
        .flatpickr-day.selected {
            background: #EC008C;
            border-color: #EC008C;
            color: #fff !important;
            opacity: 1 !important;
        }
        .flatpickr-day.disabled,
        .flatpickr-day.disabled:hover,
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            background: transparent !important;
            color: #ffffff !important;
            opacity: 0.35 !important;
            cursor: not-allowed !important;
            text-decoration: none;
        }
        .flatpickr-calendar.showMonths-2 .flatpickr-month { width: 50% !important; }

        .view-container {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .view-hidden {
            opacity: 0;
            transform: translateX(30px);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: inherit;
            pointer-events: none;
            display: none;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 640px) {
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .summary-card {
            background: rgba(0,0,0,0.2);
            padding: 1.25rem;
            border-radius: 0.75rem;
        }
        .summary-card.full-width {
            grid-column: 1 / -1;
        }
        .summary-card-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #c4b5fd;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .summary-card-label svg {
            width: 1rem;
            height: 1rem;
        }
        .summary-card-value {
            font-weight: 700;
            font-size: 1.125rem;
            color: #fff;
        }
        .summary-card-value.price {
            color: #5eead4;
            font-size: 1.5rem;
        }
        .policy-box {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(0, 174, 239, 0.1);
            border-left: 3px solid #00AEEF;
            border-radius: 0.5rem;
        }
        .policy-box p {
            font-size: 0.875rem;
            line-height: 1.6;
            color: rgba(233, 213, 255, 0.9);
        }
        .button-group {
            display: flex;
            flex-direction: column-reverse;
            gap: 1rem;
            margin-top: 2.5rem;
        }
        @media (min-width: 640px) {
            .button-group {
                flex-direction: row;
            }
        }
        .secondary-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
            animation: none;
        }
        .secondary-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .clear-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
        }
        .clear-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }
        .form-actions-container {
            text-align: center;
        }
    </style>
</head>
<body class="antialiased relative">
    <div class="relative min-h-screen">
        <div class="blobs-container">
            <div class="blob blob-1"></div>
            <div class="blob blob-2"></div>
        </div>
        
        <main class="relative z-10 flex items-center justify-center min-h-screen py-12 px-4">
            <div class="glass-effect" style="position: relative;">
                
                <!-- === VISTA DEL FORMULARIO === -->
                <div id="booking-view" class="view-container">
                    <div class="header-container">
                        <h1 class="text-2xl sm:text-3xl font-extrabold leading-tight mb-4 text-white title-appear">Agenda tu Consulta</h1>
                        <p class="prose-style text-sm sm:text-base">Te doy una cÃ¡lida bienvenida. Buscar apoyo es un acto de valentÃ­a y estoy aquÃ­ para acompaÃ±arte en tu proceso. Selecciona el servicio que mejor se adapte a tu momento actual para comenzar.</p>
                    </div>
                    
                    <form id="booking-form">
                        <div class="form-group">
                            <div class="step-header">
                                <div class="step-indicator">1</div>
                                <div>
                                    <h3 class="step-title">Elige tu Servicio</h3>
                                    <p class="step-description">Selecciona el tipo de consulta que mejor se ajusta a tu necesidad actual.</p>
                                </div>
                            </div>
                            <div class="consulta-selector">
                                <div class="consulta-option">
                                    <input type="radio" id="primera-vez" name="tipo-consulta" value="primera_vez_60" data-precio="50000" data-duracion="60" checked>
                                    <label for="primera-vez" class="consulta-label">
                                        <svg class="consulta-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.006 3 11.55c0 2.43.81 4.655 2.18 6.353m5.32-3.286a1.875 1.875 0 012.652 0l.625.625a1.875 1.875 0 002.652 0l.625-.625a1.875 1.875 0 012.652 0M10.5 8.25h.008v.008h-.008V8.25zm.75 4.5h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H13.5V8.25z" />
                                        </svg>
                                        <div class="consulta-text-content">
                                            <span class="font-bold">Consulta por primera vez</span>
                                            <p class="text-sm text-white/60">SesiÃ³n de 60 minutos para explorar tus necesidades, establecer objetivos y trazar un plan terapÃ©utico.</p>
                                        </div>
                                        <span class="consulta-price">$ 50.000</span>
                                    </label>
                                </div>
                                <div class="consulta-option">
                                    <input type="radio" id="seguimiento" name="tipo-consulta" value="seguimiento_45" data-precio="40000" data-duracion="45">
                                    <label for="seguimiento" class="consulta-label">
                                        <svg class="consulta-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.695v-2.695A8.25 8.25 0 005.68 9.348v2.695m0 0h4.993m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183" />
                                        </svg>
                                        <div class="consulta-text-content">
                                            <span class="font-bold">Consulta de seguimiento</span>
                                            <p class="text-sm text-white/60">SesiÃ³n de 45 minutos para profundizar en tu proceso, trabajar sobre los objetivos y consolidar tu progreso.</p>
                                        </div>
                                        <span class="consulta-price">$ 40.000</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                             <div class="step-header">
                                <div class="step-indicator">2</div>
                                <div>
                                    <h3 class="step-title">Elige Fecha y Hora</h3>
                                    <p class="step-description">Selecciona un dÃ­a en el calendario y luego elige una de las horas disponibles.</p>
                                </div>
                            </div>
                            <div id="calendar-container">
                                <div id="date-picker-inline"></div>
                            </div>
                            <div id="time-slots-wrapper">
                                <p class="time-slots-placeholder">Selecciona una fecha para ver las horas disponibles.</p>
                                <div id="time-slots"></div>
                            </div>
                            <input type="hidden" id="selected-date-time" name="selected-date-time" required>
                        </div>

                        <div class="form-group">
                             <div class="step-header">
                                <div class="step-indicator">3</div>
                                <div>
                                    <h3 class="step-title">Completa tus Datos</h3>
                                    <p class="step-description">Esta informaciÃ³n es necesaria para confirmar tu cita y enviarte el enlace de la sesiÃ³n.</p>
                                </div>
                            </div>
                            <div class="data-fields-container">
                                 <input type="text" id="nombre" name="nombre" placeholder="Nombre Completo" required>
                                 <input type="email" id="email" name="email" placeholder="Correo ElectrÃ³nico" required>
                                 <input type="tel" id="telefono" name="telefono" placeholder="TelÃ©fono (WhatsApp)" required>
                            </div>
                        </div>
                        
                        <div class="form-actions-container">
                            <button type="submit" id="review-button" class="action-button" disabled>Revisar mi Cita</button>
                            <button type="button" id="clear-form-button" class="clear-button">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1rem; height: 1rem;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.036-2.134H8.716C7.58 2.31 6.67 3.264 6.67 4.444v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                </svg>
                                <span>Limpiar Formulario</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- === VISTA DE CONFIRMACIÃ“N (Oculta por defecto) === -->
                <div id="confirmation-view" class="view-container view-hidden">
                    <div class="header-container">
                        <h1 class="text-2xl sm:text-3xl font-extrabold leading-tight mb-4 text-white title-appear">Confirma tu Cita</h1>
                        <p class="prose-style text-sm sm:text-base">Por favor, revisa que toda la informaciÃ³n sea correcta antes de continuar al pago.</p>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-card">
                            <span class="summary-card-label">
                                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                Servicio
                            </span>
                            <span class="summary-card-value" id="summary-service"></span>
                        </div>
                        <div class="summary-card">
                            <span class="summary-card-label">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 12.75h.008v.008H12v-.008z" /></svg>
                                Fecha y Hora
                            </span>
                            <span class="summary-card-value" id="summary-datetime"></span>
                        </div>
                        <div class="summary-card full-width">
                            <span class="summary-card-label">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                                Tus Datos
                            </span>
                            <p class="summary-card-value" id="summary-name"></p>
                            <p class="summary-card-value" id="summary-email"></p>
                            <p class="summary-card-value" id="summary-phone"></p>
                        </div>
                        <div class="summary-card full-width" style="background: rgba(94, 234, 212, 0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="summary-card-label" style="font-size: 1.125rem; color: #5eead4;">Total a Pagar</span>
                                <span class="summary-card-value price" id="summary-price"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="policy-box">
                        <p><b>PolÃ­tica de CancelaciÃ³n:</b> Puedes cancelar o reprogramar tu cita con hasta 24 horas de antelaciÃ³n para recibir un reembolso completo. Cancelaciones con menos de 24 horas no serÃ¡n reembolsadas.</p>
                    </div>

                    <div class="button-group">
                        <button type="button" id="edit-button" class="action-button secondary-button">Editar InformaciÃ³n</button>
                        <button type="button" id="confirm-button" class="action-button">Confirmar y Pagar</button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Scripts de Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DEL DOM ---
            const bookingView = document.getElementById('booking-view');
            const confirmationView = document.getElementById('confirmation-view');
            const form = document.getElementById('booking-form');
            const reviewButton = document.getElementById('review-button');
            const editButton = document.getElementById('edit-button');
            const confirmButton = document.getElementById('confirm-button');
            const clearFormButton = document.getElementById('clear-form-button');
            const hiddenInput = document.getElementById('selected-date-time');
            let selectedDate = null;
            let selectedTime = null;
            const timeSlotsContainer = document.getElementById('time-slots');
            const timeSlotsWrapper = document.getElementById('time-slots-wrapper');
            const timeSlotsPlaceholder = document.querySelector('.time-slots-placeholder');
            
            const colombianHolidays2025 = [
                "2025-01-01", "2025-01-06", "2025-03-24", "2025-04-17", "2025-04-18",
                "2025-05-01", "2025-06-02", "2025-06-23", "2025-06-30", "2025-07-20",
                "2025-08-07", "2025-08-18", "2025-10-13", "2025-11-03", "2025-11-17",
                "2025-12-08", "2025-12-25"
            ];
            
            const bookedAppointments = {
                "2025-09-29": ["19:00", "20:30"],
                "2025-10-04": ["11:00", "15:00", "15:30"]
            };

            const updateHiddenInputAndValidate = () => {
                if (selectedDate && selectedTime) {
                    const dateStr = selectedDate.toISOString().split('T')[0];
                    hiddenInput.value = `${dateStr} ${selectedTime}`;
                } else {
                    hiddenInput.value = '';
                }
                validateForm();
            };

            const generateTimeSlots = (date) => {
                timeSlotsContainer.innerHTML = '';
                timeSlotsWrapper.classList.add('visible');
                
                const selectedRadio = document.querySelector('input[name="tipo-consulta"]:checked');
                const interval = selectedRadio ? parseInt(selectedRadio.dataset.duracion, 10) : 60;
                
                const dayOfWeek = date.getDay();
                timeSlotsPlaceholder.style.display = 'none';
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                let slotsGenerated = 0;
                
                const dateKey = date.toISOString().split('T')[0];
                const bookedTimes = bookedAppointments[dateKey] || [];

                const createSlotButton = (time) => {
                    if (isToday && time < now) return;

                    const timeString = time.toLocaleTimeString('es-CO', { hour: 'numeric', minute: '2-digit', hour12: true });
                    const timeValue = `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                    
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'time-slot-btn';
                    btn.textContent = timeString;
                    btn.dataset.time = timeValue;

                    if (bookedTimes.includes(timeValue)) {
                        btn.disabled = true;
                    }

                    btn.addEventListener('click', () => {
                        if (btn.disabled) return;
                        document.querySelectorAll('.time-slot-btn.selected').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedTime = btn.dataset.time;
                        updateHiddenInputAndValidate();
                    });
                    timeSlotsContainer.appendChild(btn);
                    slotsGenerated++;
                };

                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    const startTime = 19 * 60;
                    const endTime = 21 * 60;
                    for (let minutes = startTime; minutes <= endTime - interval; minutes += interval) {
                        const hours = Math.floor(minutes / 60);
                        const mins = minutes % 60;
                        const time = new Date(date);
                        time.setHours(hours, mins, 0, 0);
                        createSlotButton(time);
                    }
                } else if (dayOfWeek === 6) {
                    const morningStart = 10 * 60;
                    const morningEnd = 13 * 60;
                    for (let minutes = morningStart; minutes <= morningEnd - interval; minutes += interval) {
                        const hours = Math.floor(minutes / 60);
                        const mins = minutes % 60;
                        const time = new Date(date);
                        time.setHours(hours, mins, 0, 0);
                        createSlotButton(time);
                    }
                    const afternoonStart = 14 * 60 + 30;
                    const afternoonEnd = 19 * 60;
                    for (let minutes = afternoonStart; minutes <= afternoonEnd - interval; minutes += interval) {
                        const hours = Math.floor(minutes / 60);
                        const mins = minutes % 60;
                        const time = new Date(date);
                        time.setHours(hours, mins, 0, 0);
                        createSlotButton(time);
                    }
                } else {
                     timeSlotsPlaceholder.textContent = "No hay horas disponibles en este dÃ­a.";
                     timeSlotsPlaceholder.style.display = 'flex';
                     return;
                }
                
                if (slotsGenerated === 0) {
                     timeSlotsPlaceholder.textContent = isToday ? "No hay mÃ¡s horas disponibles para hoy." : "No hay horas disponibles en este dÃ­a.";
                     timeSlotsPlaceholder.style.display = 'flex';
                }
            };

            const calendarInstance = flatpickr("#date-picker-inline", {
                locale: "es",
                inline: true,
                minDate: "today",
                showMonths: 2,
                disable: [
                    function(date) {
                        const dateStr = date.toISOString().split('T')[0];
                        return (date.getDay() === 0 || colombianHolidays2025.includes(dateStr));
                    }
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        selectedDate = selectedDates[0];
                        selectedTime = null;
                        updateHiddenInputAndValidate();
                        generateTimeSlots(selectedDate);
                    }
                }
            });

            const requiredInputs = form.querySelectorAll('[required]');
            const consultaRadios = form.querySelectorAll('input[name="tipo-consulta"]');

            const validateForm = () => {
                let allValid = true;
                requiredInputs.forEach(input => {
                    if (!input.value.trim()) allValid = false;
                });
                const isConsultaSelected = Array.from(consultaRadios).some(radio => radio.checked);
                if (!isConsultaSelected) allValid = false;
                
                reviewButton.disabled = !allValid;
            };

            const handleSelectionAnimation = (event) => {
                const selectedLabel = event.target.closest('.consulta-label');
                if (!selectedLabel) return;
                const selectedIcon = selectedLabel.querySelector('.consulta-icon');
                selectedLabel.classList.add('animate-bounce-in');
                if (selectedIcon) selectedIcon.classList.add('animate-icon-wiggle');
                setTimeout(() => {
                    selectedLabel.classList.remove('animate-bounce-in');
                    if (selectedIcon) selectedIcon.classList.remove('animate-icon-wiggle');
                }, 600);
            };

            requiredInputs.forEach(input => {
                input.addEventListener('input', validateForm);
            });
            
            consultaRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    validateForm();
                    handleSelectionAnimation(event);
                    if (selectedDate) {
                        generateTimeSlots(selectedDate);
                    }
                });
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const selectedRadio = document.querySelector('input[name="tipo-consulta"]:checked');
                const serviceText = selectedRadio.closest('.consulta-option').querySelector('.font-bold').textContent;
                const price = selectedRadio.dataset.precio;
                
                const date = new Date(hiddenInput.value);
                const formattedDate = date.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const formattedTime = date.toLocaleTimeString('es-CO', { hour: 'numeric', minute: '2-digit', hour12: true });

                document.getElementById('summary-service').textContent = serviceText;
                document.getElementById('summary-datetime').textContent = `${formattedDate}, ${formattedTime}`;
                document.getElementById('summary-name').textContent = document.getElementById('nombre').value;
                document.getElementById('summary-email').textContent = document.getElementById('email').value;
                document.getElementById('summary-phone').textContent = document.getElementById('telefono').value;
                document.getElementById('summary-price').textContent = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(price);
                
                bookingView.style.opacity = 0;
                bookingView.style.pointerEvents = 'none';
                
                setTimeout(() => {
                    bookingView.style.display = 'none';
                    confirmationView.style.display = 'block';
                    confirmationView.classList.remove('view-hidden');
                    setTimeout(() => {
                         confirmationView.style.opacity = 1;
                         confirmationView.style.transform = 'translateX(0)';
                    }, 50);
                }, 400);
            });

            editButton.addEventListener('click', () => {
                confirmationView.style.opacity = 0;
                confirmationView.style.transform = 'translateX(30px)';

                 setTimeout(() => {
                    confirmationView.classList.add('view-hidden');
                    bookingView.style.display = 'block';
                     setTimeout(() => {
                         bookingView.style.opacity = 1;
                         bookingView.style.pointerEvents = 'auto';
                    }, 50);
                }, 400);
            });
            
            confirmButton.addEventListener('click', async () => {
                // Cambiar el texto del botÃ³n para dar feedback al usuario
                confirmButton.textContent = 'Procesando...';
                confirmButton.disabled = true;
                editButton.disabled = true;

                // Recolectar los datos para enviar a la funciÃ³n de Netlify
                const selectedRadio = document.querySelector('input[name="tipo-consulta"]:checked');
                const payload = {
                    price: parseFloat(selectedRadio.dataset.precio),
                    serviceName: selectedRadio.closest('.consulta-option').querySelector('.font-bold').textContent,
                    dateTime: document.getElementById('summary-datetime').textContent,
                    email: document.getElementById('email').value
                };

                try {
                    // Llamar a la funciÃ³n de Netlify
                    const response = await fetch('/.netlify/functions/create-payment-link', {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'application/json' },
                    });
                    
                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Redirigir al usuario al checkout de Wompi
                        const checkoutUrl = `https://checkout.wompi.co/l/${result.linkId}`;
                        window.location.href = checkoutUrl;
                    } else {
                        // Si algo falla, mostrar un error
                        alert(`Error al crear el enlace de pago: ${result.message || 'Intenta de nuevo.'}`);
                        confirmButton.textContent = 'Confirmar y Pagar';
                        confirmButton.disabled = false;
                        editButton.disabled = false;
                    }
                } catch (error) {
                    alert(`OcurriÃ³ un error de conexiÃ³n. Por favor, revisa tu conexiÃ³n a internet.`);
                    confirmButton.textContent = 'Confirmar y Pagar';
                    confirmButton.disabled = false;
                    editButton.disabled = false;
                }
            });

            clearFormButton.addEventListener('click', () => {
                form.reset();
                document.getElementById('primera-vez').checked = true;
                calendarInstance.clear();
                timeSlotsContainer.innerHTML = '';
                timeSlotsWrapper.classList.remove('visible');
                timeSlotsPlaceholder.style.display = 'flex';
                hiddenInput.value = '';
                validateForm();
            });

            validateForm();
        });
    </script>
</body>
</html>

